<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>How to really clean your postgres database</title>
  <meta name="description" content="When in the course of human events it becomes necessary for one people to dissolve the outdated, conflicted, erring tables and columns, a decent respect to t...">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://localhost:4000/2018/06/15/how-to-really-clean-your-database.html">
  <link rel="alternate" type="application/rss+xml" title="Sam Rysdyk" href="/feed.xml">
  
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    
    
    <a class="site-title" href="/">Sam Rysdyk</a>
  
    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          <a class="page-link" href="/">Posts</a>
					<a class="page-link" href="/about">About</a>
        </div>
      </nav>
    
  </div>
</header>

    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">How to really clean your postgres database</h1>
    <p class="post-meta">
      <time datetime="2018-06-15T05:00:00-05:00" itemprop="datePublished">
        
        Jun 15, 2018
      </time>
      </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>When in the course of human events it becomes necessary for one people to dissolve the outdated, conflicted, erring tables and columns, a decent respect to the opinions of mankind requires cleaning that database!</p>

<p>It’s not hard to mess up a database. One common situation is running a migration on one git branch, and then switching to another branch and running migrations. While git takes care of changes to your code, it doesn’t change your underlying database. It’s important that actually read the git diff on the schema before committing because you may be including database info from another branch! Furthermore, if you’re working on a shared code base, somebody else might check in a dirty schema and you might pull it and use before you realize what has happened.</p>

<p>This post is about (really) clean your Ruby on Rails database. Examples will be done with Mac terminal and Postgres. However, concepts here are general enough to work on other OS and DB.</p>

<h1 id="setup">Setup</h1>

<p>For example, if your tests are looking a little funny. Various things are suddenly failing even though the code related to those things hasn’t changed. Here is the simplest way to clean things up for testing.</p>

<p>RAILS_ENV=test rake db:setup
RAILS_ENV=test rake test</p>

<p>This is a combination of a couple db commands:</p>
<ul>
  <li>db:create</li>
  <li>db:schema:load</li>
  <li>db:seed</li>
</ul>

<h1 id="reset">Reset</h1>

<p>WARNING: this will lose your data!</p>

<p>rake db:reset</p>

<p>This is a combination of:</p>
<ul>
  <li>db:drop</li>
  <li>db:setup</li>
</ul>

<h1 id="the-big-guns">The Big Guns</h1>

<p>If the above doesn’t work, it might be tempting to edit old migration files. This is probably not a great diea.</p>

<p>Instead, it might be time to manually go into Postgres and figure out what’s going on.</p>

<p>log into postgres from command line:</p>

<p><code class="highlighter-rouge">psql postgres</code></p>

<p>From here, you’ll want to see your databases</p>

<p><code class="highlighter-rouge">\l</code></p>

<p>(that’s backslash lowercase-letter-l)</p>

<p>This will list out all your databases</p>

<p>From here, you’ll want to connect to the problematic database
<code class="highlighter-rouge">\c database_name</code>  The c is short for connect.</p>

<p>Once in here, you can list out all of the tables to see what is acutally in there:
<code class="highlighter-rouge">\dt</code></p>

<p>Now were going to run some SQL.</p>

<p>For example, if the migration is complaining that a certain column does or doesn’t exist:
<code class="highlighter-rouge">ALTER TABLE table_name ADD COLUMN column_name type;</code> or,
<code class="highlighter-rouge">ALTER TABLE table_name DROP COLUMN column_name;</code></p>

<p>For example, I was trying to migrate and I kept getting an error for uuid_generate_v4()</p>

<p>The solution was to add the uuid extension. After connecting to my table, I ran:
<code class="highlighter-rouge">CREATE EXTENSION "uuid-ossp" SCHEMA public;</code></p>

<p>Boom, no more uuid_generate_v4() errors and no need to alter my schema.</p>

<p>And finally, to exit out of postgres type:
<code class="highlighter-rouge">\q</code>
to quit</p>

<p>Remember the semi-colon at the end of an SQL statement, it won’t work without it.</p>


  </div>

  
</article>

      </div>
    </main>

    <footer class="site-footer">
  <div class="wrapper">
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
           
             <li><a href="mailto:samuel.rysdyk@gmail.com">samuel.rysdyk@gmail.com</a></li>
           
           
             <li>Github: <a href="https://github.com/rysdyk">rysdyk</a></li>
           
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul>
          
            
            
          
            
            
              <li><a class="page-link" href="/about/">About</a></li>
            
          
            
            
              <li><a class="page-link" href="/books/">Books</a></li>
            
          
            
            
              <li><a class="page-link" href="/code/">Code</a></li>
            
          
            
            
          
            
            
          
            
            
          
        </ul>
      </div>
    </div>
  </div>
</footer>

  </body>

</html>
